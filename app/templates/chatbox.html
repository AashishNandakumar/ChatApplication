<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <title>Professional Chat Interface</title>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                height: 100%;
                background-color: #f5f5f5;
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
                background-color: #fff;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            .chat-header {
                background-color: #f0f0f0;
                padding: 10px;
                display: flex;
                align-items: center;
            }
            .avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #007bff;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                margin-right: 10px;
            }
            .user-info {
                flex-grow: 1;
            }
            .user-name {
                font-weight: bold;
            }
            .user-status {
                font-size: 0.8em;
                color: #28a745;
            }
            #chat-text {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
                border: none;
                resize: none;
                font-family: inherit;
                /* max-height: 5000px; */
            }
            .message {
                margin-bottom: 10px;
                max-width: 80%;
            }
            .message-sent {
                margin-left: auto;
                text-align: right;
            }
            .message-received {
                margin-right: auto;
                text-align: left;
            }
            .message-content {
                padding: 10px;
                border-radius: 20px;
                display: inline-block;
            }
            .message-sent .message-content {
                background-color: #007bff;
                color: white;
            }
            .message-received .message-content {
                background-color: #e9ecef;
            }
            .message-time {
                font-size: 0.7em;
                color: #6c757d;
                margin-top: 5px;
            }
            .form-group {
                padding: 20px;
                background-color: #f8f9fa;
                display: flex;
                align-items: center;
            }
            #input {
                flex-grow: 1;
                padding: 10px;
                border: 1px solid #ced4da;
                border-radius: 20px;
                margin-right: 10px;
            }
            #submit {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 20px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="chat-header">
                <div class="avatar">{{chat_box_name|slice:":2"}}</div>
                <div class="user-info">
                    <div class="user-name">{{chat_box_name}}</div>
                    <div class="user-status">Online</div>
                </div>
            </div>
            <div class="row d-flex justify-content-center">
                <div class="col">
                    <form>
                        <div class="form-group">
                            <!-- <textarea
                                class="form-control"
                                id="chat-text"
                                readonly
                                rows="10"
                            ></textarea> -->
                            <div id="chat-text" class="form-control"></div>
                        </div>
                        <div class="form-group">
                            <input
                                class="form-control"
                                placeholder="Type a message"
                                id="input"
                                type="text"
                            />
                            <input
                                class="btn btn-primary"
                                id="submit"
                                type="button"
                                value="Send"
                            />
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {{ request.user.username|json_script:"user_username" }}
        {{chat_box_name|json_script:"room-name" }}

        <script>
            const user_username = JSON.parse(
                document.getElementById("user_username").textContent,
            );
            // console.log("username: ", user_username);

            const boxName = JSON.parse(
                document.getElementById("room-name").textContent,
            );
            // console.log("boxName: ", boxName);

            const chatSocket = new WebSocket(
                "ws://" + window.location.host + "/ws/chat/" + boxName + "/",
            );

            // Function to generate a color based on username
            function getAvatarColor(username) {
                let hash = 0;
                for (let i = 0; i < username.length; i++) {
                    hash = username.charCodeAt(i) + ((hash << 5) - hash);
                }
                const hue = hash % 360;
                return `hsl(${hue}, 70%, 50%)`;
            }

            document.querySelector("#submit").onclick = function (e) {
                // console.log("iam being pressed");
                const messageInputDom = document.querySelector("#input");
                const message = messageInputDom.value;
                chatSocket.send(
                    JSON.stringify({
                        message: message,
                        username: user_username,
                    }),
                );
                messageInputDom.value = "";
            };

            chatSocket.onopen = function (e) {
                console.log("WebSocket connection established.");
            };

            chatSocket.onerror = function (e) {
                console.error("WebSocket error: ", e); // Log any errors in the WebSocket connection
            };

            chatSocket.onclose = function (e) {
                console.log("WebSocket closed.");
            };

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const chatText = document.querySelector("#chat-text");
                const messageDiv = document.createElement("div");
                messageDiv.className =
                    data.username === user_username
                        ? "message message-sent"
                        : "message message-received";

                // Create user avatar
                const avatarSpan = document.createElement("span");
                avatarSpan.className = "user-avatar";
                avatarSpan.style.backgroundColor = getAvatarColor(
                    data.username,
                );
                avatarSpan.textContent = data.username.charAt(0).toUpperCase();

                // // Create username display
                // const usernameSpan = document.createElement("span");
                // usernameSpan.className = "message-username";
                // usernameSpan.textContent = data.username;

                const contentSpan = document.createElement("span");
                contentSpan.className = "message-content";
                contentSpan.textContent = data.message;

                const timeSpan = document.createElement("div");
                timeSpan.className = "message-time";
                timeSpan.textContent = new Date().toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });

                if (data.username !== user_username) {
                    messageDiv.appendChild(avatarSpan);
                    // messageDiv.appendChild(usernameSpan);
                }
                messageDiv.appendChild(contentSpan);
                messageDiv.appendChild(timeSpan);

                chatText.appendChild(messageDiv);
                chatText.scrollTop = chatText.scrollHeight;
            };
        </script>
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script
            src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
